<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Negotiation Test Client</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    video { width: 480px; height: 270px; background: #000; }
    #subs { border: 1px solid #ccc; padding: 8px; width: 480px; height: 80px; overflow: auto; white-space: pre-wrap; }
    .row { display:flex; gap:20px; margin-top:10px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <h1>Live Negotiation (WebRTC + YAML)</h1>

  <div class="row">
    <div>
      <label>Model:
        <select id="model">
          <option value="mock_local">Mock Local</option>
          <option value="veo3">Veo3 (stub/fallback)</option>
        </select>
      </label>
      <button id="create">Create Session</button>
      <p>Session: <code id="sid">â€”</code></p>
      <video id="remoteVideo" autoplay playsinline></video>
      <div id="subs"></div>
    </div>
    <div>
      <textarea id="utter" rows="6" cols="40" placeholder="Say something to your envoyâ€¦"></textarea><br/>
      <button id="send">Send Utterance</button>
      <p>Status: <span id="status">idle</span></p>
    </div>
  </div>

<script>
(async function() {
  const ydump = obj => jsyaml.dump(obj);
  const yload = str => jsyaml.load(str);
  const $ = id => document.getElementById(id);

  let sid = null;
  let ws = null;
  let pc = null;
  let dc = null;

  async function createSession() {
    const model = $("model").value;
    const res = await fetch("/v1/session", {
      method: "POST",
      headers: {"Content-Type":"application/x-yaml"},
      body: ydump({ model })
    });
    const text = await res.text();
    const data = yload(text);
    sid = data.session_id;
    $("sid").textContent = sid;
    $("status").textContent = "session created";
    await startWebRTC();
    await openWS();
  }

  async function startWebRTC() {
    pc = new RTCPeerConnection();
    pc.oniceconnectionstatechange = () => $("status").textContent = pc.iceConnectionState;
    pc.ontrack = (e) => {
      if (e.track.kind === "video") $("remoteVideo").srcObject = e.streams[0];
    };

    // Mic
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const res = await fetch(`/v1/session/${sid}/webrtc/offer`, {
      method: "POST",
      headers: {"Content-Type":"application/json"}, // FastAPI reads pydantic here, YAML is only for app-level bodies
      body: JSON.stringify({ type: "offer", sdp: offer.sdp })
    });
    const y = yload(await res.text());
    await pc.setRemoteDescription({ type: y.type, sdp: y.sdp });
  }

  async function openWS() {
    ws = new WebSocket(`ws://${location.host}/v1/session/${sid}/control`);
    ws.onopen = () => $("status").textContent = "ws open";
    ws.onmessage = (ev) => {
      const obj = yload(ev.data);
      if (obj.type === "subtitle") {
        $("subs").textContent += (obj.final ? "ðŸŸ¢ " : "â€¦ ") + obj.text + "\n";
        $("subs").scrollTop = $("subs").scrollHeight;
      } else if (obj.type === "intent") {
        $("subs").textContent += "ðŸ“œ INTENT:\n" + ydump(obj.payload) + "\n";
        $("subs").scrollTop = $("subs").scrollHeight;
      } else if (obj.type === "safety") {
        $("subs").textContent += "âš ï¸ SAFETY: " + JSON.stringify(obj.payload) + "\n";
      }
    };
    ws.onclose = () => $("status").textContent = "ws closed";
  }

  $("create").onclick = createSession;
  $("send").onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      const text = $("utter").value.trim();
      if (text) ws.send(ydump({ type: "player_utterance", text }));
    }
  };
})();
</script>
</body>
</html>
